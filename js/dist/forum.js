(()=>{var t={n:e=>{var o=e&&e.__esModule?()=>e.default:()=>e;return t.d(o,{a:o}),o},d:(e,o)=>{for(var r in o)t.o(o,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:o[r]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};(()=>{"use strict";const e=flarum.core.compat["forum/app"];var o=t.n(e);const r=flarum.core.compat["common/extend"],a=flarum.core.compat["forum/utils/UserControls"];var n=t.n(a);const i=flarum.core.compat["common/components/Button"];var s=t.n(i);const u=flarum.core.compat["forum/components/UserCard"];var l=t.n(u);const p=flarum.core.compat["common/helpers/icon"];var c=t.n(p);function d(t,e){return d=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},d(t,e)}const f=flarum.core.compat["common/components/Modal"];var h=t.n(f);const g=flarum.core.compat["common/utils/Stream"];var b=t.n(g),v=function(t){function e(){return t.apply(this,arguments)||this}var r,a;a=t,(r=e).prototype=Object.create(a.prototype),r.prototype.constructor=r,d(r,a);var n=e.prototype;return n.oninit=function(e){t.prototype.oninit.call(this,e),this.user=this.attrs.user,this.expirations=this.user.attribute("groupExpirations")||{},this.groupId=b()(""),this.days=b()(""),this.currentExpirationLabel=b()("请选择群组查看"),this.newExpirationLabel=b()("-"),this.computedDate=""},n.className=function(){return"ExpirationModal Modal--small"},n.title=function(){return"延长群组有效期"},n.content=function(){var t=this;return m("div",{className:"Modal-body"},m("div",{className:"Form-group"},m("label",null,"选择群组"),m("select",{className:"FormControl",value:this.groupId(),onchange:function(e){return t.onGroupChange(e.target.value)}},m("option",{value:"",disabled:!0},"请选择..."),o().store.all("groups").filter(function(t){return"2"!==t.id()&&"3"!==t.id()}).map(function(t){return m("option",{key:t.id(),value:t.id()},t.namePlural())}))),m("div",{className:"Form-group",style:"background: #f9f9f9; padding: 10px; border-radius: 5px; border: 1px solid #eee;"},m("label",{style:"font-size: 12px; color: #666; margin-bottom: 2px;"},"当前有效期"),m("div",{style:"font-weight: bold; color: #333;"},this.currentExpirationLabel())),m("div",{className:"Form-group"},m("label",null,"增加时长 (天数)"),m("input",{type:"number",className:"FormControl",placeholder:"例如: 30",value:this.days(),oninput:function(e){return t.calcNewDate(e.target.value)},disabled:!this.groupId()}),m("div",{className:"helpText"},"输入负数可以减少时长。")),m("div",{className:"Form-group",style:"background: #e8f3ff; padding: 10px; border-radius: 5px; border: 1px solid #d0e3f5;"},m("label",{style:"font-size: 12px; color: #4d698e; margin-bottom: 2px;"},"预计新有效期"),m("div",{style:"font-weight: bold; color: #2b4566; font-size: 1.1em;"},this.newExpirationLabel())),m("div",{className:"Form-group"},s().component({type:"submit",className:"Button Button--primary",disabled:!this.groupId()||!this.days(),loading:this.loading},"确认保存")))},n.onGroupChange=function(t){this.groupId(t);var e=this.expirations[t];if(e){var o=new Date(e);this.currentExpirationLabel(o.toLocaleDateString())}else this.currentExpirationLabel("当前无有效期 (将从现在开始计算)");this.calcNewDate(this.days())},n.calcNewDate=function(t){if(this.days(t),!t||!this.groupId())return this.newExpirationLabel("-"),void(this.computedDate="");var e=new Date,o=e;if(this.expirations[this.groupId()]){var r=new Date(this.expirations[this.groupId()]);r>e&&(o=r)}var a=new Date(o.getTime());a.setDate(a.getDate()+parseInt(t)),this.newExpirationLabel(a.toLocaleDateString()),this.computedDate=a.toISOString()},n.onsubmit=function(t){var e=this;t.preventDefault(),this.loading=!0;var r=new Date,a=new Date(r.getTime());a.setDate(a.getDate()+parseInt(this.days())),o().request({method:"POST",url:o().forum.attribute("apiUrl")+"/group-expiration",body:{userId:this.user.id(),groupId:this.groupId(),expirationDate:a.toISOString()}}).then(function(){e.hide(),o().alerts.show({type:"success"},"设置成功！"),window.location.reload()}).catch(function(){e.loading=!1,m.redraw()})},e}(h());o().initializers.add("hertz-dev-group-expiration",function(){(0,r.extend)(n(),"userControls",function(t,e){o().session.user&&e.attribute("canSetGroupExpiration")&&t.add("expiration",s().component({icon:"fas fa-clock",onclick:function(){return o().modal.show(v,{user:e})}},o().translator.trans("hertz-dev-group-expiration.forum.user_controls.edit_button")))}),(0,r.extend)(l().prototype,"infoItems",function(t){var e=this.attrs.user.attribute("groupExpiration");e&&t.add("groupExpiration",m("span",{className:"UserCard-group-expiration"},[c()("fas fa-hourglass-half")," ",o().translator.trans("hertz-dev-group-expiration.forum.user_card.expiration_label",{date:e.split("T")[0]})]))})})})(),module.exports={}})();
//# sourceMappingURL=forum.js.map