(()=>{var t={n:o=>{var e=o&&o.__esModule?()=>o.default:()=>o;return t.d(e,{a:e}),e},d:(o,e)=>{for(var n in e)t.o(e,n)&&!t.o(o,n)&&Object.defineProperty(o,n,{enumerable:!0,get:e[n]})},o:(t,o)=>Object.prototype.hasOwnProperty.call(t,o)};(()=>{"use strict";const o=flarum.core.compat["forum/app"];var e=t.n(o);const n=flarum.core.compat["common/extend"],r=flarum.core.compat["forum/utils/UserControls"];var a=t.n(r);const i=flarum.core.compat["common/components/Button"];var s=t.n(i);const u=flarum.core.compat["forum/components/UserCard"];var c=t.n(u);const l=flarum.core.compat["forum/components/SettingsPage"];var d=t.n(l);const p=flarum.core.compat["common/helpers/icon"];var f=t.n(p);const h=flarum.core.compat["common/helpers/fullTime"];var g=t.n(h);function v(t,o){return v=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,o){return t.__proto__=o,t},v(t,o)}function y(t,o){t.prototype=Object.create(o.prototype),t.prototype.constructor=t,v(t,o)}const b=flarum.core.compat["common/components/Modal"];var N=t.n(b);const x=flarum.core.compat["common/utils/Stream"];var w=t.n(x),D=function(t){function o(){return t.apply(this,arguments)||this}y(o,t);var n=o.prototype;return n.oninit=function(o){t.prototype.oninit.call(this,o),this.user=this.attrs.user,this.groupId=w()(""),this.date=w()(""),this.days=w()("")},n.className=function(){return"ExpirationModal Modal--small"},n.title=function(){return"加权"},n.content=function(){var t=this;return m("div",{className:"Modal-body"},m("div",{className:"Form-group"},m("label",null,"选择群组"),m("select",{className:"FormControl",value:this.groupId(),onchange:function(o){return t.groupId(o.target.value)}},m("option",{value:"",disabled:!0},"请选择..."),e().store.all("groups").filter(function(t){return"2"!==t.id()&&"3"!==t.id()}).map(function(t){return m("option",{key:t.id(),value:t.id()},t.namePlural())}))),m("div",{className:"Form-group"},m("label",null,"过期时长 (天数)"),m("input",{type:"number",className:"FormControl",placeholder:"例如: 30",value:this.days(),oninput:function(o){return t.syncDate(o.target.value)}})),m("div",{className:"Form-group"},m("label",null,"过期日期 (自动计算)"),m("input",{type:"date",className:"FormControl",value:this.date(),onchange:function(o){return t.syncDays(o.target.value)}})),m("div",{className:"Form-group"},s().component({type:"submit",className:"Button Button--primary",disabled:!this.groupId()||!this.date()},"保存设置")))},n.syncDate=function(t){if(this.days(t),t){var o=new Date;o.setDate(o.getDate()+parseInt(t));var e=o.toISOString().split("T")[0];this.date(e)}else this.date("")},n.syncDays=function(t){if(this.date(t),t){var o=new Date,e=new Date(t)-o,n=Math.ceil(e/864e5);this.days(n>0?n:0)}else this.days("")},n.onsubmit=function(t){var o=this;t.preventDefault(),this.loading=!0,e().request({method:"POST",url:e().forum.attribute("apiUrl")+"/group-expiration",body:{userId:this.user.id(),groupId:this.groupId(),expirationDate:this.date()}}).then(function(){o.hide(),e().alerts.show({type:"success"},"设置成功！用户已加入群组并设定了过期时间。"),window.location.reload()}).catch(function(){o.loading=!1,m.redraw()})},o}(N()),I=function(t){function o(){return t.apply(this,arguments)||this}y(o,t);var n=o.prototype;return n.oninit=function(o){t.prototype.oninit.call(this,o),this.code=w()(""),this.loading=!1},n.className=function(){return"RedeemModal Modal--small"},n.title=function(){return"兑换群组权益"},n.content=function(){return m("div",{className:"Modal-body"},m("div",{className:"Form-group"},m("label",null,"请输入您的兑换码"),m("input",{className:"FormControl",placeholder:"例如：VIP-8888",bidi:this.code,disabled:this.loading})),m("div",{className:"Form-group"},m(s(),{className:"Button Button--primary Button--block",loading:this.loading,onclick:this.onsubmit.bind(this)},"立即兑换")))},n.onsubmit=function(t){var o=this;t.preventDefault(),this.loading=!0,e().request({method:"POST",url:e().forum.attribute("apiUrl")+"/redemption/redeem",body:{code:this.code()},errorHandler:this.onerror.bind(this)}).then(function(t){o.loading=!1,e().modal.close(),e().alerts.show({type:"success"},t.message),window.location.reload()}).catch(function(){o.loading=!1,m.redraw()})},o}(N());e().initializers.add("hertz-dev-group-expiration",function(){(0,n.extend)(d().prototype,"accountItems",function(t){t.add("redeem-code",s().component({className:"Button",icon:"fas fa-gift",onclick:function(){return e().modal.show(I)}},"兑换权益"))}),(0,n.extend)(a(),"userControls",function(t,o){e().session.user&&o.attribute("canSetGroupExpiration")&&t.add("expiration",s().component({icon:"fas fa-clock",onclick:function(){return e().modal.show(D,{user:o})}},e().translator.trans("hertz-dev-group-expiration.forum.user_controls.edit_button")))}),(0,n.extend)(c().prototype,"infoItems",function(t){var o=this.attrs.user.attribute("groupExpiration");o&&t.add("groupExpiration",m("span",{className:"UserCard-group-expiration"},[f()("fas fa-hourglass-half")," ",e().translator.trans("hertz-dev-group-expiration.forum.user_card.expiration_label",{date:g()(o)})]))})})})(),module.exports={}})();
//# sourceMappingURL=forum.js.map